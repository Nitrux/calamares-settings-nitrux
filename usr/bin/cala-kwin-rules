#! /bin/bash

set -x


### (force) Add kwin rules for calamares

root_xdg_path="/etc/xdg/"
user_xdg_path="$HOME/.config"

if [ -f "$user_xdg_path"/kwinrulesrc ]
    then
        rm "$user_xdg_path"/kwinrulesrc 
    else
        $(which cp) "$root_xdg_path/kwinrulesrc"
fi

>> "$user_xdg_path/kwinrulesrc" printf "%s\n" \
    '[3]' \
    'Description=Calamares' \
    'above=true' \
    'aboverule=2' \
    'desktopfile=io.calamares.calamares' \
    'desktopfilerule=3' \
    'fullscreen=true' \
    'fullscreenrule=2' \
    'position=-2,30' \
    'positionrule=0' \
    'types=1' \
    'wmclass=calamares calamares' \
    '' \

sed -i 's+count=2+count=3+g' "$user_xdg_path"/kwinrulesrc
sed -i 's+rules=1,2+rules=1,2,3+g' "$user_xdg_path"/kwinrulesrc

sleep 1

#   restart kwin otherwise rules aren't loaded

if pgrep -x "kwin_x11" > /dev/null
    then
        kwin_x11 --replace &
    else
        kwin_wayland --replace &
fi

sleep 1

exit 0
