#!/bin/bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2023-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Variables.

TOOL_NAME="Calamares Startup"


# -- Environment variables.

export QT_QUICK_CONTROLS_STYLE=org.kde.breeze


# -- Print messages to stderr.

_puts() {
    [ -n "${1-}" ] || return 0

    level=$1
    shift || true

    [ $# -gt 0 ] || return 0

    case "$level" in
        info)    color='34'; label='Info' ;;
        success) color='32'; label='Success' ;;
        warning) color='33'; label='Warning' ;;
        error)   color='31'; label='Error' ;;
        *)       color='0';  label="$level" ;;
    esac

    if [ "$level" = "error" ]; then
        printf '%s: \033[%sm%s:\033[0m %b\n' "${TOOL_NAME-}" "$color" "$label" "$*" >&2
    else
        printf '%s: \033[%sm%s:\033[0m %s\n' "${TOOL_NAME-}" "$color" "$label" "$*" >&2
    fi
}

puts_info()    { _puts info "$@"; }
puts_success() { _puts success "$@"; }
puts_warning() { _puts warning "$@"; }
puts_error()   { _puts error "$@"; }

print_message() {
    if [ $# -eq 0 ]; then
        printf '\n' >&2
    else
        printf '%s\n' "$@" >&2
    fi
}


# -- Unmount swap before starting Calamres; otherwise, Calamares can't partition disks when running in a VM. 
# -- I do not know why swap is automatically mounted *ONLY* in Live sessions in VMs.

if swapon --show | grep -q '/dev/'; then
    puts_info "SWAP partition is currently mounted. Unmounting..."
    swapoff -a
    puts_success "SWAP partition has been unmounted."
else
    puts_error "SWAP partition is not mounted."
fi


# -- Launch Calamares.

puts_info "Starting Calamares..."

calamares -D6
