import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

import org.kde.kirigami 2.7 as Kirigami

import Qt5Compat.GraphicalEffects

import "."

import io.calamares.ui 1.0
import io.calamares.core 1.0

Page
{
    id: control

    property string subtitle
    property string message
    property alias icon : _icon

    property alias stackView: _stackView

    default property alias content : _card.data

        property alias backButton : _backButton

        signal goBack()

        background: Rectangle
        {
            id: _background
            color: control.Kirigami.Theme.backgroundColor

            Image
            {
                id: _wallpaper
                height: parent.height
                width: parent.width

                sourceSize.height: 2160
                sourceSize.width: 3780

                fillMode: Image.PreserveAspectCrop
                antialiasing: false
                smooth: false
                asynchronous: true
                cache: true
                source: "./calamares_bg_image.png"
            }

            FastBlur
            {
                id: fastBlur
                anchors.fill: parent
                source: _wallpaper
                radius: 130
                transparentBorder: false
                cached: true
            }

            OpacityMask
            {
                source: mask
                maskSource: parent
            }

            LinearGradient
            {
                id: mask
                anchors.fill: parent
                gradient: Gradient
                {
                    GradientStop { position: 0.6; color: "transparent"}
                    GradientStop { position: 0.9; color: _background.color}
                }

                start: Qt.point(0, 0)
                end: Qt.point(0, control.height-48)
            }
        }

        ColumnLayout
        {
            anchors.centerIn: parent
            height: Math.min(800, parent.height * 0.95)
            width: Math.min(1200, parent.width * 0.95)
            Page
            {
                id: _card
                clip: true

                Layout.fillWidth: true
                Layout.fillHeight: true

                Component.onCompleted: fadeIn.start()

                NumberAnimation on opacity
                {
                    id: fadeIn
                    duration: 150
                    from: 0
                    to: 1.0
                    easing.type: Easing.OutQuad
                }

                header: ToolBar
                {
                    visible: _stackView.depth > 1
                    background: null

                    ToolButton
                    {
                        id:_backButton
                        text: _stackView.get(Math.max(0, _stackView.currentItem.StackView.index - 1), StackView.DontLoad).title
                        icon.name: "go-previous"
                        flat: true
                        onClicked:
                        {
                            if(_stackView.depth > 1)
                            {
                                _stackView.pop()
                            }

                            control.goBack()

                        }
                    }
                }

                background: Rectangle
                {
                    color: Kirigami.Theme.backgroundColor
                    radius: 20
                }

                RowLayout
                {
                    anchors.fill: parent
                    anchors.margins: Kirigami.Units.largeSpacing * 6
                    spacing: Kirigami.Units.largeSpacing * 2

                    ColumnLayout
                    {
                        id: _content
                        Layout.fillHeight: true
                        Layout.fillWidth: true
                        Layout.margins: Kirigami.Units.largeSpacing * 2
                        Layout.maximumWidth: 400
                        Layout.alignment: Qt.AlignVCenter | Qt.AlignHCenter

                        spacing:  Kirigami.Units.largeSpacing * 2

                        Item
                        {
                            Layout.fillWidth: true
                            Layout.preferredHeight: 100

                            Kirigami.Icon
                            {
                                id: _icon
                                height: 80
                                width: height
                                anchors.centerIn: parent
                                FadeBehavior on source { fadeProperty: "scale" }
                            }
                        }

                        Label
                        {
                            Layout.fillWidth: true
                            Layout.preferredHeight: Math.min(implicitHeight, 200)
                            horizontalAlignment: Qt.AlignHCenter
                            wrapMode: Text.Wrap
                            elide: Text.ElideMiddle
                            text: control.title
                            font.bold: true
                            font.weight: Font.Bold
                            font.pointSize: 24
                            FadeBehavior on text { }
                        }

                        Label
                        {
                            Layout.fillWidth: true
                            Layout.preferredHeight: Math.min(implicitHeight, 200)
                            horizontalAlignment: Qt.AlignHCenter
                            wrapMode: Text.Wrap
                            elide: Text.ElideMiddle
                            text: control.subtitle
                            font.weight: Font.Light
                            font.pointSize: 12
                            FadeBehavior on text { }
                        }

                        Label
                        {
                            Layout.fillWidth: true
                            Layout.preferredHeight: Math.min(implicitHeight, 200)
                            horizontalAlignment: Qt.AlignHCenter
                            wrapMode: Text.Wrap
                            elide: Text.ElideMiddle
                            text: control.message
                            font.weight: Font.Light
                            font.pointSize: 10
                            FadeBehavior on text { }
                        }
                    }

                    StackView
                    {
                        id: _stackView
                        Layout.fillHeight: true
                        Layout.fillWidth: true

                        Layout.alignment: Qt.AlignVCenter | Qt.AlignHCenter

                        Layout.margins: Kirigami.Units.largeSpacing * 2

                        Layout.minimumWidth: 300
                        Layout.maximumWidth: 500

                        Layout.maximumHeight:  currentItem.implicitHeight
                        Layout.minimumHeight: 200


                        clip: true

                        pushEnter: Transition
                        {
                            NumberAnimation {
                                property: "opacity"
                                duration: 150
                                to: 1
                                easing.type: Easing.OutQuad
                            }
                        }

                        popEnter: Transition
                        {
                            NumberAnimation {
                                property: "opacity"
                                duration: 150
                                to: 1
                                easing.type: Easing.OutQuad
                            }
                        }

                        popExit: Transition
                        {
                            NumberAnimation {
                                property: "opacity"
                                duration: 150
                                to: 0
                                easing.type: Easing.InQuad
                            }
                        }

                        pushExit: Transition
                        {
                            NumberAnimation {
                                property: "opacity"
                                duration: 150
                                to: 0
                                easing.type: Easing.InQuad
                            }
                        }
                    }
                }
            }

        ViewStepsBar
        {
            Layout.fillWidth: true
            Layout.maximumWidth: 900
            Layout.minimumWidth: 400
            Layout.alignment: Qt.AlignCenter
        }

    }
}
